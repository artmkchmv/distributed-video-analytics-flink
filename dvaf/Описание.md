# Полное описание системы распределенной обработки видеопотоков

## Общее описание системы

Система распределенной обработки видеопотоков представляет собой масштабируемое решение для анализа видео в реальном времени. Система построена на базе Apache Flink для потоковой обработки данных, Apache Kafka для передачи сообщений, Apache Cassandra для хранения результатов и ZooKeeper для координации компонентов.

### Основные возможности

- **Обработка видеопотоков в реальном времени**: Система способна обрабатывать множественные видеопотоки одновременно
- **Динамическое масштабирование**: Автоматическое создание и распределение Kafka топиков в зависимости от нагрузки
- **Детекция движения**: Использование алгоритмов компьютерного зрения для обнаружения движения в кадрах
- **Отказоустойчивость**: Использование Flink checkpointing для восстановления после сбоев
- **Координация через ZooKeeper**: Управление назначениями камер к топикам через распределенную координацию

## Архитектура системы

### Общая схема потока данных

```
┌─────────────┐
│ Video Files │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────────────────────┐
│                    Producer Node                         │
│  - Чтение видео через OpenCV                             │
│  - Кодирование кадров в JSON                            │
│  - Отправка в Kafka                                      │
│  - Регистрация камер в ZooKeeper                        │
│  - Отслеживание назначений топиков                      │
└──────┬──────────────────────────────────────────────────┘
       │
       │ JSON (VideoFrameData)
       ▼
┌─────────────────────────────────────────────────────────┐
│                    Kafka Cluster                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ video-events-0│  │ video-events-1│  │ video-events-N│   │
│  └──────────────┘  └──────────────┘  └──────────────┘   │
│  (Динамически создаваемые топики)                        │
└──────┬──────────────────────────────────────────────────┘
       │
       │ Подписка по паттерну video-events-.*
       ▼
┌─────────────────────────────────────────────────────────┐
│              Flink Processor Node                        │
│  - Потоковая обработка через Flink                       │
│  - Детекция движения (OpenCV)                           │
│  - Сохранение результатов                               │
└──────┬──────────────────────────────────────────────────┘
       │
       ├──────────────────┬──────────────────┐
       ▼                  ▼                  ▼
┌─────────────┐  ┌──────────────┐  ┌──────────────┐
│ Cassandra   │  │ Filesystem   │  │ Checkpointing│
│ (Metadata)  │  │ (Images)     │  │ (State)      │
└─────────────┘  └──────────────┘  └──────────────┘

       ┌──────────────────────────────────────┐
       │         ZooKeeper                    │
       │  - /dvaf/cameras/{camId}             │
       │  - /dvaf/assignments/{camId}         │
       └──────┬───────────────────────────────┘
              │
              │ Мониторинг изменений
              ▼
       ┌──────────────────────────────────────┐
       │         Scaler Node                  │
       │  - Отслеживание камер                │
       │  - Создание топиков                  │
       │  - Распределение камер               │
       └──────────────────────────────────────┘
```

## Описание узлов системы

### 1. Producer Node (Узел производителя)

**Назначение**: Чтение видеопотоков, преобразование кадров в JSON и отправка в Kafka.

**Основной класс**: `com.ssau.producer.VideoProducer`

#### Функциональность

1. **Инициализация**:
   - Загрузка конфигурации из `producer.properties`
   - Создание Kafka Producer с настройками сериализации
   - Инициализация `TopicAssignmentManager` для работы с ZooKeeper
   - Регистрация камер в ZooKeeper

2. **Обработка видеопотоков**:
   - Для каждой камеры создается отдельный поток (`VideoEventCreator`)
   - Чтение кадров через OpenCV `VideoCapture`
   - Изменение размера кадров до 640x480
   - Кодирование кадров в Base64
   - Создание JSON объектов `VideoFrameData`
   - Отправка в назначенный Kafka топик

3. **Отчетность о нагрузке**:
   - Периодическая отправка метрик FPS в ZooKeeper
   - Обновление узла камеры с информацией о нагрузке

#### Классы и их функции

##### `VideoProducer`
- **Функция**: Главный класс приложения
- **Методы**:
  - `main(String[] args)`: Точка входа, инициализация компонентов
  - `createKafkaProducer(Properties)`: Создание Kafka Producer с настройками
  - `startCameraThreads(...)`: Запуск потоков обработки для каждой камеры
  - `TopicInfo.fromProperties(Properties)`: Извлечение информации о топиках из конфигурации

##### `VideoEventCreator` (implements Runnable)
- **Функция**: Обработка видеопотока одной камеры
- **Поля**:
  - `cameraId`: Идентификатор камеры
  - `url`: Путь к видеофайлу или индекс камеры
  - `producer`: Kafka Producer для отправки сообщений
  - `assignmentManager`: Менеджер назначений топиков
  - `loadReportIntervalMs`: Интервал отчетности о нагрузке
- **Методы**:
  - `run()`: Основной цикл обработки
  - `createEvent()`: Чтение видео и отправка кадров
  - `openCamera()`: Открытие видеопотока (файл или устройство)
  - `resolveVideoPath(String)`: Разрешение пути к видеофайлу
  - `createJsonFromMat(Mat)`: Преобразование OpenCV Mat в JSON
  - `sendMessage(String)`: Отправка сообщения в Kafka

##### `TopicAssignmentManager`
- **Функция**: Управление назначениями камер к Kafka топикам через ZooKeeper
- **Поля**:
  - `curator`: CuratorFramework для работы с ZooKeeper
  - `camerasPath`: Путь к узлам камер в ZooKeeper (`/dvaf/cameras`)
  - `assignmentsPath`: Путь к назначениям (`/dvaf/assignments`)
  - `defaultTopic`: Топик по умолчанию
  - `cameraTopics`: Map для хранения текущих назначений топиков
  - `assignmentCaches`: Кэши для отслеживания изменений назначений
- **Методы**:
  - `start()`: Инициализация подключения к ZooKeeper
  - `registerCameras(Collection<String>)`: Регистрация списка камер
  - `registerCamera(String)`: Регистрация одной камеры
  - `reportCameraLoad(String, double)`: Отчет о нагрузке камеры (FPS)
  - `topicFor(String)`: Получение назначенного топика для камеры
  - `startAssignmentWatcher(String)`: Запуск отслеживания изменений назначения
  - `createOrReplaceCameraNode(String, String)`: Создание/обновление узла камеры
  - `ReRegisterOnReconnect`: Обработчик переподключения к ZooKeeper

##### `VideoFrameData` (модель)
- **Поля**:
  - `camId`: Идентификатор камеры
  - `timestamp`: Временная метка кадра (Instant)
  - `rows`: Высота кадра
  - `cols`: Ширина кадра
  - `type`: Тип матрицы OpenCV
  - `data`: Base64-кодированные данные кадра

##### `ConfigLoader`
- **Функция**: Загрузка конфигурации из файлов properties
- **Методы**:
  - `loadDefault()`: Загрузка конфигурации с учетом локальных настроек

### 2. Scaler Node (Узел масштабирования)

**Назначение**: Управление динамическим масштабированием Kafka топиков на основе количества и нагрузки камер.

**Основной класс**: `com.ssau.scaler.TopicScalerApp`

#### Функциональность

1. **Мониторинг камер**:
   - Отслеживание изменений в реестре камер через ZooKeeper PathChildrenCache
   - Реагирование на добавление/удаление камер

2. **Вычисление необходимых топиков**:
   - Формула: `ceil(количество_камер / maxCamerasPerTopic)`
   - Учет минимального количества топиков (`minTopicCount`)

3. **Создание топиков**:
   - Использование Kafka AdminClient для создания топиков
   - Настройка количества партиций и фактора репликации
   - Установка `max.message.bytes` для больших сообщений

4. **Распределение камер**:
   - Равномерное распределение камер по топикам
   - Создание/обновление назначений в ZooKeeper
   - Удаление назначений для неактивных камер

#### Классы и их функции

##### `TopicScalerApp`
- **Функция**: Точка входа приложения Scaler
- **Методы**:
  - `main(String[] args)`: Инициализация и запуск TopicScaler

##### `TopicScaler` (implements Closeable)
- **Функция**: Основная логика масштабирования топиков
- **Поля**:
  - `curator`: CuratorFramework для ZooKeeper
  - `adminClient`: Kafka AdminClient для управления топиками
  - `cameraCache`: PathChildrenCache для отслеживания камер
  - `reconcileExecutor`: ExecutorService для выполнения операций согласования
  - `baseTopic`: Базовое имя топика (например, "video-events")
  - `topicPartitions`: Количество партиций в топике
  - `replicationFactor`: Фактор репликации
  - `maxCamerasPerTopic`: Максимальное количество камер на топик
  - `minTopicCount`: Минимальное количество топиков
- **Методы**:
  - `TopicScaler(Properties)`: Конструктор, инициализация компонентов
  - `reconcileAssignments(String)`: Согласование назначений (синхронизированный метод)
  - `ensureTopicCount(int)`: Создание недостающих топиков в Kafka
  - `applyAssignments(List<String>, int)`: Применение назначений камер к топикам
  - `topicName(int)`: Генерация имени топика по индексу
  - `awaitShutdown()`: Ожидание завершения работы
  - `CameraChangeListener`: Слушатель изменений в реестре камер

##### `CameraChangeListener` (внутренний класс)
- **Функция**: Обработка событий изменения реестра камер
- **События**:
  - `CHILD_ADDED`: Добавлена новая камера → запуск согласования
  - `CHILD_REMOVED`: Удалена камера → запуск согласования
  - `CHILD_UPDATED`: Обновлена информация о камере (игнорируется)
  - `CONNECTION_RECONNECTED`: Переподключение к ZooKeeper (игнорируется)

### 3. Processor Node (Узел обработки)

**Назначение**: Потоковая обработка видеокадров из Kafka с использованием Apache Flink, детекция движения и сохранение результатов.

**Основной класс**: `com.ssau.processor.VideoProcessor`

#### Функциональность

1. **Инициализация Flink**:
   - Создание StreamExecutionEnvironment
   - Настройка checkpointing для отказоустойчивости
   - Установка параллелизма обработки

2. **Источник данных**:
   - Подписка на Kafka топики по паттерну `video-events-.*`
   - Использование KafkaSource с поддержкой динамических топиков
   - Настройка стратегии offset (earliest/latest)

3. **Обработка потока**:
   - Парсинг JSON в объекты `VideoFrameData`
   - Фильтрация невалидных кадров
   - Группировка по `camId` (keyBy)
   - Обработка кадров с детекцией движения
   - Сохранение результатов в Cassandra и файловую систему

4. **Детекция движения**:
   - Сравнение текущего кадра с предыдущим
   - Преобразование в оттенки серого
   - Применение Gaussian blur
   - Вычисление разности кадров
   - Пороговая обработка
   - Поиск контуров движения
   - Сохранение кадров с обнаруженным движением

#### Классы и их функции

##### `VideoProcessor`
- **Функция**: Главный класс Flink job
- **Методы**:
  - `main(String[] args)`: Точка входа, создание и запуск Flink job
  - `buildKafkaSource(Properties)`: Построение KafkaSource с подпиской по паттерну
  - `JsonToFrameMapper`: Преобразование JSON строк в VideoFrameData
  - `FrameProcessorFunction`: Обработка кадров с детекцией движения

##### `JsonToFrameMapper` (extends RichMapFunction)
- **Функция**: Парсинг JSON в объекты VideoFrameData
- **Методы**:
  - `map(String)`: Десериализация JSON строки

##### `FrameProcessorFunction` (extends KeyedProcessFunction)
- **Функция**: Обработка кадров с сохранением состояния
- **Поля**:
  - `previousFrameState`: ValueState для хранения предыдущего обработанного кадра
  - `outputDir`: Директория для сохранения изображений
  - `processingMode`: Режим обработки (MOTION)
- **Методы**:
  - `open(Configuration)`: Инициализация состояния
  - `processElement(...)`: Обработка каждого кадра
    - Получение предыдущего кадра из состояния
    - Вызов детектора движения
    - Обновление состояния
    - Создание ProcessingResult
    - Эмиссия результата в поток

##### `MotionDetector`
- **Функция**: Алгоритм детекции движения
- **Методы**:
  - `detectMotion(...)`: Основной метод детекции
    - Декодирование предыдущего кадра (если есть)
    - Преобразование в оттенки серого
    - Применение Gaussian blur
    - Обработка текущего кадра
    - Вычисление разности кадров (absdiff)
    - Пороговая обработка (threshold)
    - Поиск контуров движения
    - Отрисовка прямоугольников вокруг областей движения
    - Сохранение изображений с обнаруженным движением
  - `decodeMat(VideoFrameData)`: Декодирование Base64 в OpenCV Mat
  - `detectContours(Mat)`: Поиск контуров движения
  - `saveImage(Mat, VideoFrameData, String)`: Сохранение изображения на диск

##### `FrameProcessorHelper`
- **Функция**: Вспомогательный класс для обработки кадров
- **Методы**:
  - `processMotionFrame(...)`: Обертка для вызова MotionDetector

##### `CassandraSinkFunction` (extends RichSinkFunction)
- **Функция**: Сохранение результатов обработки в Cassandra
- **Поля**:
  - `cassandraService`: Сервис для работы с Cassandra
  - `cassandraProps`: Свойства подключения
- **Методы**:
  - `open(Configuration)`: Инициализация CassandraService
  - `invoke(ProcessingResult, Context)`: Сохранение результата
  - `close()`: Закрытие соединения

##### `CassandraService`
- **Функция**: Работа с базой данных Cassandra
- **Поля**:
  - `session`: CqlSession для выполнения запросов
  - `insertStatement`: Подготовленный запрос для вставки
- **Методы**:
  - `CassandraService(Properties)`: Конструктор с подключением и инициализацией схемы
  - `createKeyspace(String)`: Создание keyspace если не существует
  - `createTable(String)`: Создание таблицы processing_results
  - `insertResult(...)`: Вставка результата обработки
  - `close()`: Закрытие сессии

##### `ProcessingResult` (модель)
- **Поля**:
  - `id`: UUID результата
  - `cameraId`: Идентификатор камеры
  - `frameTimestamp`: Временная метка кадра
  - `processingTimestamp`: Временная метка обработки
  - `detectionType`: Тип детекции (motion)
  - `detectionCount`: Количество обнаруженных объектов
  - `frameRows`: Высота кадра
  - `frameCols`: Ширина кадра
  - `imagePath`: Путь к сохраненному изображению
  - `metadata`: Дополнительные метаданные

##### `VideoFrameData` (модель)
- **Поля**: Аналогично модели в Producer (см. выше)

## Взаимодействие узлов

### Сценарий запуска системы

1. **Запуск инфраструктуры**:
   - ZooKeeper: координация и хранение метаданных
   - Kafka: брокер сообщений
   - Flink JobManager/TaskManager: обработка потоков
   - Cassandra: хранение результатов

2. **Запуск Scaler Node**:
   - Подключение к ZooKeeper
   - Подключение к Kafka AdminClient
   - Инициализация PathChildrenCache для мониторинга камер
   - Ожидание регистрации камер

3. **Запуск Producer Node**:
   - Подключение к ZooKeeper
   - Регистрация камер в `/dvaf/cameras/{camId}`
   - Запуск отслеживания назначений в `/dvaf/assignments/{camId}`
   - Начало отправки кадров в топик по умолчанию

4. **Реакция Scaler Node**:
   - Обнаружение новых камер через PathChildrenCache
   - Вычисление необходимого количества топиков
   - Создание недостающих топиков в Kafka
   - Распределение камер по топикам
   - Создание назначений в ZooKeeper

5. **Реакция Producer Node**:
   - Обнаружение изменений назначений через CuratorCache
   - Переключение на новый топик
   - Продолжение отправки кадров в новый топик

6. **Запуск Processor Node**:
   - Подключение к Kafka по паттерну `video-events-.*`
   - Автоматическое обнаружение всех топиков
   - Начало обработки кадров из всех топиков
   - Сохранение результатов в Cassandra и файловую систему

### Поток данных

1. **Видео → Producer**:
   - OpenCV читает кадры из видеофайла/устройства
   - Кадры изменяются до 640x480
   - Кодирование в Base64
   - Создание JSON объекта VideoFrameData
   - Отправка в Kafka топик (назначенный Scaler)

2. **Producer → Kafka**:
   - Сообщения отправляются асинхронно
   - Используется сжатие gzip
   - Batch обработка для эффективности
   - Ключ сообщения: `camId`

3. **Kafka → Processor**:
   - Flink KafkaSource подписывается на все топики по паттерну
   - Автоматическое обнаружение новых топиков
   - Парсинг JSON в VideoFrameData
   - Группировка по `camId`

4. **Processor → Обработка**:
   - Для каждого кадра:
     - Получение предыдущего кадра из состояния
     - Детекция движения
     - Сохранение изображения (если движение обнаружено)
     - Обновление состояния
     - Создание ProcessingResult

5. **Processor → Cassandra**:
   - Вставка метаданных результата
   - Структура таблицы:
     - Primary Key: `(camera_id, day), frame_timestamp, id`
     - Clustering: по `frame_timestamp DESC`

6. **Processor → Filesystem**:
   - Сохранение изображений с обнаруженным движением
   - Формат имени: `{camId}-T-{timestamp}.png`
   - Путь: `processed.output.dir/{camId}-T-{timestamp}.png`

## Особенности масштабирования

### Механизм масштабирования

1. **Триггеры масштабирования**:
   - Добавление новой камеры (CHILD_ADDED в ZooKeeper)
   - Удаление камеры (CHILD_REMOVED в ZooKeeper)
   - Начальный запуск системы

2. **Алгоритм распределения**:
   ```
   requiredTopics = max(minTopicCount, ceil(cameras.size() / maxCamerasPerTopic))
   topicIndex = min(requiredTopics - 1, cameraIndex / maxCamerasPerTopic)
   topic = baseTopic + "-" + topicIndex
   ```

3. **Примеры**:
   - 3 камеры, maxCamerasPerTopic=4: 1 топик (video-events-0)
   - 5 камер, maxCamerasPerTopic=4: 2 топика (video-events-0, video-events-1)
     - Камеры 0-3 → video-events-0
     - Камера 4 → video-events-1
   - 10 камер, maxCamerasPerTopic=4: 3 топика
     - Камеры 0-3 → video-events-0
     - Камеры 4-7 → video-events-1
     - Камеры 8-9 → video-events-2

### Преимущества подхода

- **Горизонтальное масштабирование**: Добавление новых топиков при росте нагрузки
- **Равномерное распределение**: Камеры распределяются равномерно по топикам
- **Автоматическое обнаружение**: Processor автоматически подписывается на новые топики
- **Отказоустойчивость**: Каждый топик независим, сбой одного не влияет на другие

## Потоки данных

### Основной поток обработки

```
Video File
    ↓
OpenCV VideoCapture
    ↓
Mat (640x480)
    ↓
Base64 Encoding
    ↓
VideoFrameData (JSON)
    ↓
Kafka Producer
    ↓
Kafka Topic (video-events-N)
    ↓
Flink KafkaSource
    ↓
JSON String
    ↓
JsonToFrameMapper
    ↓
VideoFrameData
    ↓
KeyBy(camId)
    ↓
FrameProcessorFunction
    ↓
Motion Detection
    ↓
ProcessingResult
    ↓
    ├─→ CassandraSinkFunction → Cassandra
    └─→ Filesystem (Images)
```

### Поток координации

```
Producer
    ↓
Register Camera in ZooKeeper (/dvaf/cameras/{camId})
    ↓
Scaler (PathChildrenCache detects change)
    ↓
Calculate Required Topics
    ↓
Create Topics in Kafka
    ↓
Create Assignments in ZooKeeper (/dvaf/assignments/{camId})
    ↓
Producer (CuratorCache detects change)
    ↓
Switch to Assigned Topic
    ↓
Continue Sending Frames
```

### Поток отчетности о нагрузке

```
Producer (VideoEventCreator)
    ↓
Count Frames (every loadReportIntervalMs)
    ↓
Calculate FPS
    ↓
Update ZooKeeper Node (/dvaf/cameras/{camId})
    ↓
Data: "fps={fps};ts={timestamp}"
```

## Отказоустойчивость

### Flink Checkpointing

- **Назначение**: Сохранение состояния обработки для восстановления после сбоев
- **Конфигурация**:
  - Интервал: `flink.checkpoint.interval.ms` (по умолчанию 60000 мс)
  - Хранилище: `flink.checkpoint.dir` (файловая система)
- **Сохраняемое состояние**:
  - Позиции чтения из Kafka (offset)
  - Состояние KeyedProcessFunction (previousFrameState)

### ZooKeeper Ephemeral Nodes

- **Назначение**: Автоматическое удаление узлов камер при отключении Producer
- **Механизм**: Узлы камер создаются с флагом `CreateMode.EPHEMERAL`
- **Результат**: При отключении Producer узел автоматически удаляется, Scaler перераспределяет камеры

### Kafka Durability

- **Назначение**: Гарантия доставки сообщений
- **Настройки Producer**:
  - `acks=all`: Ожидание подтверждения от всех реплик
  - `retries=3`: Повторные попытки при ошибках
  - `max.request.size`: Поддержка больших сообщений

### Cassandra Persistence

- **Назначение**: Надежное хранение результатов обработки
- **Структура**: Репликация данных для отказоустойчивости
- **Схема**: Партиционирование по `(camera_id, day)` для эффективных запросов

## Конфигурация и настройка

### Ключевые параметры

#### Producer
- `kafka.bootstrap.servers`: Адреса Kafka брокеров
- `camera.id`: Список идентификаторов камер
- `camera.url`: Пути к видеофайлам или индексы устройств
- `scaler.load.report.interval.ms`: Интервал отчетности о нагрузке

#### Scaler
- `scaler.max.cameras.per.topic`: Максимальное количество камер на топик
- `scaler.min.topics`: Минимальное количество топиков
- `kafka.topic.partitions`: Количество партиций в топике
- `kafka.topic.replication.factor`: Фактор репликации

#### Processor
- `flink.parallelism`: Параллелизм обработки
- `flink.checkpoint.interval.ms`: Интервал checkpointing
- `kafka.offset.strategy`: Стратегия чтения (earliest/latest)
- `processed.output.dir`: Директория для сохранения изображений

## Заключение

Система представляет собой масштабируемое решение для обработки видеопотоков в реальном времени с поддержкой динамического масштабирования, отказоустойчивости и координации через ZooKeeper. Архитектура позволяет легко добавлять новые камеры и автоматически распределять нагрузку по множественным Kafka топикам, обеспечивая высокую производительность и надежность обработки.

